---
- name: Create Attribute Uniqueness entries
  ldap_entry:
    server_uri: "ldapi://%2fdata%2frun%2fslapd-localhost.socket"
    dn: "cn={{ attr_uniq }} Attribute Uniqueness,cn=plugins,cn=config"
    objectClass:
      - top
      - extensibleObject
      - nsslapdplugin
    attributes:
      nsslapd-plugin-depends-on-type: database
      nsslapd-pluginDescription: Enforce unique attribute values
      nsslapd-pluginEnabled: "on"
      nsslapd-pluginId: NSUniqueAttr
      nsslapd-pluginInitfunc: NSUniqueAttr_Init
      nsslapd-pluginPath: libattr-unique-plugin
      nsslapd-pluginType: betxnpreoperation
      nsslapd-pluginVendor: 389 Project
      nsslapd-pluginVersion: none
      uniqueness-attribute-name: "{{ attr_uniq }}"
      uniqueness-subtrees: "{{ dirsrv_domain }}"
    state: present
  notify: restart_dirsrv
  loop:
    - uid
    - userid
    - mail
    - uidNumber
    - gidNumber
  loop_control:
    loop_var: attr_uniq
  register: result
  retries: 5
  delay: 1
  until: result is not failed

- name: Assert Attribute Uniqueness configuration
  ldap_attrs:
    server_uri: "ldapi://%2fdata%2frun%2fslapd-localhost.socket"
    dn: "cn={{ attr_uniq }} Attribute Uniqueness,cn=plugins,cn=config"
    attributes:
      nsslapd-pluginEnabled: "on"
      uniqueness-attribute-name: "{{ attr_uniq }}"
      uniqueness-subtrees: "{{ dirsrv_domain }}"
    state: exact
  notify: restart_dirsrv
  loop:
    - uid
    - userid
    - mail
    - uidNumber
    - gidNumber
  loop_control:
    loop_var: attr_uniq
  register: result
  retries: 5
  delay: 1
  until: result is not failed
