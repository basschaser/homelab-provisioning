---
- name: Create 'jellyfin' service account
  ldap_entry:
    server_uri: "ldapi://%2fdata%2frun%2fslapd-localhost.socket"
    dn: "cn=jellyfin,ou=services,{{ dirsrv_domain }}"
    objectClass:
      - simpleSecurityObject
      - organizationalRole
    attributes:
      cn: Jellyfin
      description: Jellyfin Service Account
      userPassword: mG2FHb8ptWwegp
    state: present
  register: result
  retries: 5
  delay: 1
  until: result is not failed

- name: Assert that 'jellyfin' account has 'user_read' permission
  ldap_attrs:
    server_uri: "ldapi://%2fdata%2frun%2fslapd-localhost.socket"
    dn: "cn=user_read,ou=permissions,{{ dirsrv_domain }}"
    attributes:
      member: "cn=jellyfin,ou=services,{{ dirsrv_domain }}"
    state: present
  register: result
  retries: 5
  delay: 1
  until: result is not failed

- name: Assert that 'jellyfin' account has 'user_passwd_reset' permission
  ldap_attrs:
    server_uri: "ldapi://%2fdata%2frun%2fslapd-localhost.socket"
    dn: "cn=user_passwd_reset,ou=permissions,{{ dirsrv_domain }}"
    attributes:
      member: "cn=jellyfin,ou=services,{{ dirsrv_domain }}"
    state: present
  register: result
  retries: 5
  delay: 1
  until: result is not failed
