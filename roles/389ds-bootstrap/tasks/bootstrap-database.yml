---
- name: Create the database backend
  command: |
    dsconf
    -D "cn=Directory Manager"
    -w "password"
    ldaps://ldap.homelab.internal
    backend create
    --suffix {{ dirsrv_domain }}
    --be-name userRoot

- name: "Create Entry 1 : Domain Root"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: "{{ dirsrv_domain }}"
    objectClass:
      - top
      - domain
    attributes:
      dc: homelab
      description: "{{ dirsrv_domain }}"
      aci:
        (targetattr="dc || description || objectClass")
        (targetfilter="(objectClass=domain)")
        (version 3.0;
          acl "Enable anyone domain read";
          allow (read, search, compare)
          (userdn="ldap:///anyone");
        )
      aci:
        (targetattr="ou || objectClass")
        (targetfilter="(objectClass=organizationalUnit)")
        (version 3.0;
          acl "Enable anyone ou read";
          allow (read, search, compare)
          (userdn="ldap:///anyone");
        )
    state: present
  notify: restart_dirsrv

- name: "Create Entry 2 : 389DS System"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=389_ds_system,{{ dirsrv_domain }}
    objectClass:
      - top
      - nscontainer
      - ldapsubentry
    attributes:
      cn: 389_ds_system
    state: present
  notify: restart_dirsrv

- name: "Create Entry 3 : Groups OU"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: ou=groups,{{ dirsrv_domain }}
    objectClass:
      - top
      - organizationalUnit
    attributes:
      ou: groups
      aci:
        (targetattr="cn || member || gidNumber || nsUniqueId || description || objectClass")
        (targetfilter="(objectClass=groupOfNames)")
        (version 3.0;
          acl "Enable anyone group read";
          allow (read, search, compare)
          (userdn="ldap:///anyone");
        )
      aci:
        (targetattr="member")
        (targetfilter="(objectClass=groupOfNames)")
        (version 3.0;
          acl "Enable group_modify to alter members";
          allow (write)
          (groupdn="ldap:///cn=group_modify,ou=permissions,{{ dirsrv_domain }}");
        )
      aci:
        (targetattr="cn || member || gidNumber || description || objectClass")
        (targetfilter="(objectClass=groupOfNames)")
        (version 3.0;
          acl "Enable group_admin to manage groups";
          allow (write, add, delete)
          (groupdn="ldap:///cn=group_admin,ou=permissions,{{ dirsrv_domain }}");
        )
    state: present
  notify: restart_dirsrv

- name: "Create Entry 4 : People OU"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: ou=people,{{ dirsrv_domain }}
    objectClass:
      - top
      - organizationalUnit
    attributes:
      ou: people
      aci:
        (targetattr="objectClass || description || nsUniqueId || uid || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || nsSshPublicKey || nsAccountLock || userCertificate")
        (targetfilter="(objectClass=posixaccount)")
        (version 3.0;
          acl "Enable only user self read";
          allow (read, search, compare)
          (userdn="ldap:///self");
        )
      aci:
        (targetattr="displayName || legalName || userPassword || nsSshPublicKey")
        (version 3.0;
          acl "Enable self partial modify";
          allow (write)
          (userdn="ldap:///self");
        )
      aci:
        (targetattr="legalName || telephoneNumber || mobile || sn")
        (targetfilter="(|(objectClass=nsPerson)(objectClass=inetOrgPerson))")
        (version 3.0;
          acl "Enable self legalname read";
          allow (read, search, compare)
          (userdn="ldap:///self");
        )
      aci:
        (targetattr="legalName || telephoneNumber")
        (targetfilter="(objectClass=nsPerson)")
        (version 3.0;
          acl "Enable user legalname read";
          allow (read, search, compare)
          (groupdn="ldap:///cn=user_private_read,ou=permissions,{{ dirsrv_domain }}");
        )
      aci:
        (targetattr="uid || description || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || legalName || telephoneNumber || mobile")
        (targetfilter="(&(objectClass=nsPerson)(objectClass=nsAccount))")
        (version 3.0;
          acl "Enable user admin create";
          allow (write, add, delete, read)
          (groupdn="ldap:///cn=user_admin,ou=permissions,{{ dirsrv_domain }}");
        )
      aci:
        (targetattr="uid || description || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || legalName || telephoneNumber || mobile")
        (targetfilter="(&(objectClass=nsPerson)(objectClass=nsAccount))")
        (version 3.0;
          acl "Enable user modify to change users";
          allow (write, read)
          (groupdn="ldap:///cn=user_modify,ou=permissions,{{ dirsrv_domain }}");
        )
      aci:
        (targetattr="userPassword || nsAccountLock || userCertificate || nsSshPublicKey")
        (targetfilter="(objectClass=nsAccount)")
        (version 3.0;
          acl "Enable user password reset";
          allow (write, read)
          (groupdn="ldap:///cn=user_passwd_reset,ou=permissions,{{ dirsrv_domain }}");
        )
      aci:
        (targetattr="objectClass || description || nsUniqueId || uid || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || nsSshPublicKey || nsAccountLock || userCertificate || employeeType")
        (targetfilter="(objectClass=nsAccount)")
        (version 3.0;
          acl "Enable only user read";
          allow (read, search, compare)
          (groupdn="ldap:///cn=user_read,ou=permissions,{{ dirsrv_domain }}");
        )
    state: present
  notify: restart_dirsrv

- name: "Create Entry 5 : Permissions OU"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - organizationalUnit
    attributes:
      ou: permissions
    state: present
  notify: restart_dirsrv

- name: "Create Entry 6 : Services OU"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: ou=services,{{ dirsrv_domain }}
    objectClass:
      - top
      - organizationalUnit
    attributes:
      ou: services
      aci: (
        targetattr="objectClass || description || nsUniqueId || cn || memberOf || nsAccountLock")
        (targetfilter="(objectClass=netscapeServer)")
        (version 3.0;
          acl "Enable anyone service account read";
          allow (read, search, compare)
          (userdn="ldap:///anyone");
        )
    state: present
  notify: restart_dirsrv

- name: "Create Entry 7 : Permission - Group Admin"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=group_admin,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: group_admin
    state: present
  notify: restart_dirsrv

- name: "Create Entry 8 : Permission - Group Modify"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=group_modify,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: group_modify
    state: present
  notify: restart_dirsrv

- name: "Create Entry 9 : Permission - User Admin"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=user_admin,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: user_admin
    state: present
  notify: restart_dirsrv

- name: "Create Entry 10 : Permission - User Modify"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=user_modify,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: user_modify
    state: present
  notify: restart_dirsrv

- name: "Create Entry 11 : Permission - User Password Reset"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=user_passwd_reset,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: user_passwd_reset
    state: present
  notify: restart_dirsrv

- name: "Create Entry 12 : Permission - User Private Read"
  ldap_entry:
    bind_dn: cn=Directory Manager
    bind_pw: password
    server_uri: ldaps://ldap.homelab.internal
    validate_certs: yes
    dn: cn=user_private_read,ou=permissions,{{ dirsrv_domain }}
    objectClass:
      - top
      - groupOfNames
      - nsMemberOf
    attributes:
      cn: user_private_read
    state: present
  notify: restart_dirsrv
