---
- name: Check for existing swap file
  ansible.builtin.stat:
    path: /.swapfile
  register: swapfile

- name: Ensure swap file exists
  ansible.builtin.file:
    path: /.swapfile
    owner: root
    group: root
    mode: 0600
    seuser: system_u
    serole: object_r
    setype: swapfile_t
    state: touch
  when: not swapfile.stat.exists

- name: Zero-fill the swap file
  ansible.builtin.command: "dd if=/dev/zero of=/.swapfile bs=1M count={{ size }}"
  when: not swapfile.stat.exists

- name: Format the swap file
  ansible.builtin.command: mkswap /.swapfile
  when: not swapfile.stat.exists

- name: Activate the swap file
  ansible.builtin.command: swapon /.swapfile
  when: not swapfile.stat.exists

- name: Create the fstab entry
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: /.swapfile    swap    swap    defaults    0 0
